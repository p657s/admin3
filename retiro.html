<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Panel Admin - Solicitudes de Retiro</title>

<style>
:root{
  --bg:#f8f9fa;
  --border:#e5e7eb;
  --muted:#6b7280;
  --text:#1f2937;
  --accent:#2f855a;
  --card-bg:#ffffff;
  --success:#10b981;
  --warning:#f59e0b;
  --danger:#ef4444;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
}

*{box-sizing:border-box;}
html,body{
  margin:0;
  padding:0;
  height:100%;
  background:var(--bg);
  color:var(--text);
  font-size:14px;
}

.container{
  max-width:1400px;
  margin:0 auto;
  padding:24px;
}

.header{
  background:#fff;
  border-bottom:2px solid var(--border);
  padding:20px 24px;
  margin:-24px -24px 24px -24px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.header-title{
  font-size:24px;
  font-weight:700;
  color:var(--text);
  margin:0;
}

.stats-container{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
  gap:20px;
  margin-bottom:24px;
}

.stat-card{
  background:#fff;
  border:1px solid var(--border);
  border-radius:8px;
  padding:20px;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.stat-label{
  font-size:13px;
  color:var(--muted);
  text-transform:uppercase;
  font-weight:600;
  letter-spacing:0.5px;
}

.stat-value{
  font-size:28px;
  font-weight:700;
  color:var(--text);
}

.stat-value.success{color:var(--success);}
.stat-value.warning{color:var(--warning);}
.stat-value.danger{color:var(--danger);}

.filter-bar{
  background:#fff;
  border:1px solid var(--border);
  border-radius:8px;
  padding:16px;
  margin-bottom:24px;
  display:flex;
  gap:12px;
  align-items:center;
  flex-wrap:wrap;
}

.filter-label{
  font-weight:600;
  font-size:13px;
}

.filter-select{
  padding:8px 12px;
  border:1px solid var(--border);
  border-radius:6px;
  font-size:14px;
  background:#fff;
  cursor:pointer;
}

.refresh-btn{
  margin-left:auto;
  padding:8px 16px;
  background:var(--accent);
  color:#fff;
  border:none;
  border-radius:6px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s;
}

.refresh-btn:hover{
  background:#276749;
}

.table-container{
  background:#fff;
  border:1px solid var(--border);
  border-radius:8px;
  overflow:hidden;
}

.table-header{
  padding:16px 20px;
  border-bottom:2px solid var(--border);
  font-weight:600;
  font-size:15px;
}

.table-content{
  max-height:600px;
  overflow-y:auto;
}

.retiro-card{
  border-bottom:1px solid var(--border);
  padding:20px;
  transition:background 0.2s;
}

.retiro-card:hover{
  background:#f9fafb;
}

.retiro-card:last-child{
  border-bottom:none;
}

.retiro-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
}

.retiro-user{
  display:flex;
  align-items:center;
  gap:12px;
}

.user-avatar{
  width:40px;
  height:40px;
  border-radius:50%;
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-weight:700;
  font-size:16px;
}

.user-info{
  display:flex;
  flex-direction:column;
  gap:2px;
}

.user-name{
  font-weight:600;
  font-size:15px;
  color:var(--text);
}

.user-email{
  font-size:13px;
  color:var(--muted);
}

.retiro-amount{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:4px;
}

.amount-label{
  font-size:12px;
  color:var(--muted);
  text-transform:uppercase;
}

.amount-value{
  font-size:24px;
  font-weight:700;
  color:var(--success);
}

.retiro-body{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
  gap:16px;
  margin-bottom:16px;
  padding:16px;
  background:#f9fafb;
  border-radius:6px;
}

.info-item{
  display:flex;
  flex-direction:column;
  gap:4px;
}

.info-label{
  font-size:12px;
  color:var(--muted);
  text-transform:uppercase;
  font-weight:600;
}

.info-value{
  font-size:14px;
  color:var(--text);
  font-weight:500;
}

.badge{
  display:inline-block;
  padding:4px 12px;
  border-radius:12px;
  font-size:12px;
  font-weight:600;
  text-transform:uppercase;
}

.badge.pendiente{
  background:#fef3c7;
  color:#92400e;
}

.badge.aprobado{
  background:#d1fae5;
  color:#065f46;
}

.badge.rechazado{
  background:#fee2e2;
  color:#991b1b;
}

.retiro-actions{
  display:flex;
  gap:8px;
  justify-content:flex-end;
}

.btn{
  padding:8px 16px;
  border:none;
  border-radius:6px;
  font-weight:600;
  font-size:13px;
  cursor:pointer;
  transition:all 0.2s;
}

.btn-approve{
  background:var(--success);
  color:#fff;
}

.btn-approve:hover{
  background:#059669;
}

.btn-reject{
  background:var(--danger);
  color:#fff;
}

.btn-reject:hover{
  background:#dc2626;
}

.btn-view{
  background:#6b7280;
  color:#fff;
}

.btn-view:hover{
  background:#4b5563;
}

.empty-state{
  padding:60px 20px;
  text-align:center;
  color:var(--muted);
}

.empty-icon{
  font-size:64px;
  margin-bottom:16px;
  opacity:0.5;
}

.empty-text{
  font-size:16px;
  font-weight:600;
}

.loading{
  padding:40px 20px;
  text-align:center;
  color:var(--muted);
}

.spinner{
  border:3px solid #f3f4f6;
  border-top:3px solid var(--accent);
  border-radius:50%;
  width:40px;
  height:40px;
  animation:spin 1s linear infinite;
  margin:0 auto 16px;
}

@keyframes spin{
  0%{transform:rotate(0deg);}
  100%{transform:rotate(360deg);}
}

.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  z-index:1000;
  align-items:center;
  justify-content:center;
  padding:20px;
}

.modal.show{
  display:flex;
}

.modal-content{
  background:#fff;
  border-radius:12px;
  max-width:600px;
  width:100%;
  max-height:90vh;
  overflow-y:auto;
  box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);
}

.modal-header{
  padding:20px 24px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.modal-title{
  font-size:18px;
  font-weight:700;
  margin:0;
}

.modal-close{
  background:none;
  border:none;
  font-size:24px;
  cursor:pointer;
  color:var(--muted);
  padding:0;
  width:32px;
  height:32px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:4px;
}

.modal-close:hover{
  background:#f3f4f6;
}

.modal-body{
  padding:24px;
}

.detail-grid{
  display:grid;
  gap:16px;
}

.detail-item{
  display:flex;
  flex-direction:column;
  gap:4px;
  padding-bottom:16px;
  border-bottom:1px solid var(--border);
}

.detail-item:last-child{
  border-bottom:none;
  padding-bottom:0;
}

.detail-label{
  font-size:12px;
  color:var(--muted);
  text-transform:uppercase;
  font-weight:600;
}

.detail-value{
  font-size:15px;
  color:var(--text);
  font-weight:500;
}

@media(max-width:768px){
  .container{
    padding:16px;
  }
  
  .header{
    margin:-16px -16px 16px -16px;
    flex-direction:column;
    gap:12px;
    align-items:flex-start;
  }
  
  .header-title{
    font-size:20px;
  }
  
  .stats-container{
    grid-template-columns:1fr;
  }
  
  .retiro-header{
    flex-direction:column;
    align-items:flex-start;
    gap:12px;
  }
  
  .retiro-amount{
    align-items:flex-start;
  }
  
  .retiro-body{
    grid-template-columns:1fr;
  }
  
  .retiro-actions{
    flex-wrap:wrap;
  }
}
</style>
</head>

<body>

<div class="container">
  <div class="header">
    <h1 class="header-title">üìä Panel de Retiros</h1>
    <div style="font-size:13px;color:var(--muted);">Admin Dashboard</div>
  </div>

  <div class="stats-container" id="statsContainer">
    <div class="stat-card">
      <div class="stat-label">Total Solicitudes</div>
      <div class="stat-value" id="totalRetiros">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Pendientes</div>
      <div class="stat-value warning" id="pendientesRetiros">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Monto Total Pendiente</div>
      <div class="stat-value success" id="montoTotal">$0.00</div>
    </div>
  </div>

  <div class="filter-bar">
    <span class="filter-label">Filtrar:</span>
    <select class="filter-select" id="filterEstado">
      <option value="todos">Todos los estados</option>
      <option value="Pendiente">Pendientes</option>
      <option value="Aprobado">Aprobados</option>
      <option value="Rechazado">Rechazados</option>
    </select>
    <button class="refresh-btn" id="refreshBtn">üîÑ Actualizar</button>
  </div>

  <div class="table-container">
    <div class="table-header">
      Solicitudes de Retiro
    </div>
    <div class="table-content" id="retirosContainer">
      <div class="loading">
        <div class="spinner"></div>
        <div>Cargando solicitudes...</div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de detalles -->
<div class="modal" id="detailModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Detalles del Retiro</h3>
      <button class="modal-close" id="closeModal">√ó</button>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Contenido din√°mico -->
    </div>
  </div>
</div>

<script type="module">
// =================== FIREBASE SETUP ====================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDD3ihzLwnnf7ZgbEsYm5gCTt2-XQRYge0",
  authDomain: "usuarios-4a235.firebaseapp.com",
  projectId: "usuarios-4a235",
  databaseURL: "https://usuarios-4a235-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);

const database = getDatabase(app);

// ==================== VARIABLES GLOBALES ====================
let retirosData = {};
let currentFilter = 'todos';

// ==================== ELEMENTOS DOM ====================
const retirosContainer = document.getElementById('retirosContainer');
const filterEstado = document.getElementById('filterEstado');
const refreshBtn = document.getElementById('refreshBtn');
const detailModal = document.getElementById('detailModal');
const closeModal = document.getElementById('closeModal');
const modalBody = document.getElementById('modalBody');

// ==================== FUNCIONES DE RENDERIZADO ====================
function renderRetiros(retiros, filter = 'todos') {
  const filteredRetiros = Object.entries(retiros).filter(([id, retiro]) => {
    if (filter === 'todos') return true;
    return retiro.estado === filter;
  });

  if (filteredRetiros.length === 0) {
    retirosContainer.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üì≠</div>
        <div class="empty-text">No hay solicitudes de retiro</div>
      </div>
    `;
    return;
  }

  // Ordenar por timestamp descendente (m√°s recientes primero)
  filteredRetiros.sort((a, b) => {
    return new Date(b[1].timestamp) - new Date(a[1].timestamp);
  });

  let html = '';
  
  filteredRetiros.forEach(([id, retiro]) => {
    const initial = retiro.userName ? retiro.userName.charAt(0).toUpperCase() : 'U';
    const estadoClass = retiro.estado.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    
    html += `
      <div class="retiro-card">
        <div class="retiro-header">
          <div class="retiro-user">
            <div class="user-avatar">${initial}</div>
            <div class="user-info">
              <div class="user-name">${retiro.userName}</div>
              <div class="user-email">${retiro.userEmail}</div>
            </div>
          </div>
          <div class="retiro-amount">
            <div class="amount-label">Cantidad</div>
            <div class="amount-value">$${parseFloat(retiro.cantidad).toFixed(2)}</div>
          </div>
        </div>
        
        <div class="retiro-body">
          <div class="info-item">
            <div class="info-label">M√©todo de Pago</div>
            <div class="info-value">${retiro.metodoPago}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Tarjeta</div>
            <div class="info-value">**** ${retiro.tarjeta.slice(-4)}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Fecha</div>
            <div class="info-value">${retiro.fecha} ${retiro.hora}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Estado</div>
            <div class="info-value">
              <span class="badge ${estadoClass}">${retiro.estado}</span>
            </div>
          </div>
        </div>
        
        <div class="retiro-actions">
          <button class="btn btn-view" onclick="viewDetails('${id}')">üëÅÔ∏è Ver Detalles</button>
          ${retiro.estado === 'Pendiente' ? `
            <button class="btn btn-approve" onclick="updateStatus('${id}', 'Aprobado')">‚úì Aprobar</button>
            <button class="btn btn-reject" onclick="updateStatus('${id}', 'Rechazado')">‚úó Rechazar</button>
          ` : ''}
        </div>
      </div>
    `;
  });

  retirosContainer.innerHTML = html;
}

function updateStats(retiros) {
  const total = Object.keys(retiros).length;
  const pendientes = Object.values(retiros).filter(r => r.estado === 'Pendiente').length;
  const montoTotal = Object.values(retiros)
    .filter(r => r.estado === 'Pendiente')
    .reduce((sum, r) => sum + parseFloat(r.cantidad), 0);

  document.getElementById('totalRetiros').textContent = total;
  document.getElementById('pendientesRetiros').textContent = pendientes;
  document.getElementById('montoTotal').textContent = `$${montoTotal.toFixed(2)}`;
}

// ==================== FUNCIONES DE ACCIONES ====================
window.viewDetails = function(retiroId) {
  const retiro = retirosData[retiroId];
  if (!retiro) return;

  const estadoClass = retiro.estado.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  
  modalBody.innerHTML = `
    <div class="detail-grid">
      <div class="detail-item">
        <div class="detail-label">Usuario</div>
        <div class="detail-value">${retiro.userName}</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Email</div>
        <div class="detail-value">${retiro.userEmail}</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">User ID</div>
        <div class="detail-value">${retiro.userId}</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Cantidad</div>
        <div class="detail-value" style="font-size:24px;font-weight:700;color:var(--success);">$${parseFloat(retiro.cantidad).toFixed(2)}</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">M√©todo de Pago</div>
        <div class="detail-value">${retiro.metodoPago}</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">N√∫mero de Tarjeta</div>
        <div class="detail-value">${retiro.tarjeta}</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">CVC</div>
        <div class="detail-value">${retiro.cvc}</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Fecha de Caducidad</div>
        <div class="detail-value">${retiro.fechaCaducidad}</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Fecha de Solicitud</div>
        <div class="detail-value">${retiro.fecha} a las ${retiro.hora}</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Estado</div>
        <div class="detail-value">
          <span class="badge ${estadoClass}">${retiro.estado}</span>
        </div>
      </div>
    </div>
  `;
  
  detailModal.classList.add('show');
};

window.updateStatus = async function(retiroId, newStatus) {
  if (!confirm(`¬øEst√° seguro de ${newStatus === 'Aprobado' ? 'aprobar' : 'rechazar'} este retiro?`)) {
    return;
  }

  try {
    const retiroRef = ref(database, `retiros/${retiroId}`);
    await update(retiroRef, {
      estado: newStatus,
      fechaActualizacion: new Date().toISOString()
    });
    
    alert(`Retiro ${newStatus === 'Aprobado' ? 'aprobado' : 'rechazado'} exitosamente`);
  } catch (error) {
    console.error('Error al actualizar estado:', error);
    alert('Error al actualizar el estado del retiro');
  }
};

// ==================== LISTENERS ====================
filterEstado.addEventListener('change', (e) => {
  currentFilter = e.target.value;
  renderRetiros(retirosData, currentFilter);
});

refreshBtn.addEventListener('click', () => {
  refreshBtn.textContent = 'üîÑ Actualizando...';
  setTimeout(() => {
    refreshBtn.textContent = 'üîÑ Actualizar';
  }, 1000);
});

closeModal.addEventListener('click', () => {
  detailModal.classList.remove('show');
});

detailModal.addEventListener('click', (e) => {
  if (e.target === detailModal) {
    detailModal.classList.remove('show');
  }
});

// ==================== INICIALIZACI√ìN ====================
const retirosRef = ref(database, 'retiros');
onValue(retirosRef, (snapshot) => {
  const data = snapshot.val();
  
  if (data) {
    retirosData = data;
    renderRetiros(data, currentFilter);
    updateStats(data);
  } else {
    retirosContainer.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üì≠</div>
        <div class="empty-text">No hay solicitudes de retiro</div>
      </div>
    `;
    document.getElementById('totalRetiros').textContent = '0';
    document.getElementById('pendientesRetiros').textContent = '0';
    document.getElementById('montoTotal').textContent = '$0.00';
  }
});
</script>

</body>
</html>